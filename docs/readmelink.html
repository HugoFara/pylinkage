

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>pylinkage &mdash; pylinkage 0.4.1-alpha documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
        <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
        <script src="_static/jquery.js"></script>
        <script src="_static/underscore.js"></script>
        <script src="_static/doctools.js"></script>
    
    <script type="text/javascript" src="_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Changelog" href="changeloglink.html" />
    <link rel="prev" title="Welcome to pylinkage’s documentation!" href="index.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="index.html" class="icon icon-home"> pylinkage
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1 current"><a class="current reference internal" href="#">pylinkage</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#installation">Installation</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#using-pip">Using pip</a></li>
<li class="toctree-l3"><a class="reference internal" href="#setting-up-virtual-environment">Setting up Virtual Environment</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#usage">Usage</a></li>
<li class="toctree-l2"><a class="reference internal" href="#requirements">Requirements</a></li>
<li class="toctree-l2"><a class="reference internal" href="#example">Example</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#joints-definition">Joints definition</a></li>
<li class="toctree-l3"><a class="reference internal" href="#linkage-definition-and-simulation">Linkage definition and simulation</a></li>
<li class="toctree-l3"><a class="reference internal" href="#visualization">Visualization</a></li>
<li class="toctree-l3"><a class="reference internal" href="#optimization">Optimization</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="changeloglink.html">Changelog</a></li>
<li class="toctree-l1"><a class="reference internal" href="api/geometry.html">geometry</a></li>
<li class="toctree-l1"><a class="reference internal" href="api/linkage.html">linkage</a></li>
<li class="toctree-l1"><a class="reference internal" href="api/optimizer.html">optimizer</a></li>
<li class="toctree-l1"><a class="reference internal" href="api/visualizer.html">visualizer</a></li>
<li class="toctree-l1"><a class="reference internal" href="api/exceptions.html">exceptions</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">pylinkage</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="index.html">Docs</a> &raquo;</li>
        
      <li>pylinkage</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="_sources/readmelink.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <a class="reference external image-reference" href="https://pypi.python.org/pypi/pylinkage/"><img alt="PyPI version fury.io" src="https://badge.fury.io/py/pylinkage.svg" /></a>
<div class="section" id="pylinkage">
<h1>pylinkage<a class="headerlink" href="#pylinkage" title="Permalink to this headline">¶</a></h1>
<p>A linkage builder written in Python. This package is made to create planar linkages and optimize them kinematically thanks to <a class="reference external" href="https://en.wikipedia.org/wiki/Particle_swarm_optimization">Particle Swarm Optimization</a>. It is still an early work, so it should receive great changes in the future.</p>
<div class="section" id="installation">
<h2>Installation<a class="headerlink" href="#installation" title="Permalink to this headline">¶</a></h2>
<div class="section" id="using-pip">
<h3>Using pip<a class="headerlink" href="#using-pip" title="Permalink to this headline">¶</a></h3>
<p>This package is in the PyPi as <a class="reference external" href="https://pypi.org/project/pylinkage/">pylinkage</a>, and can be installed using:
<code class="docutils literal notranslate"><span class="pre">pip</span> <span class="pre">install</span> <span class="pre">pylinkage</span></code></p>
<p>It is the recommended way downloading it, since the release versions are synced.</p>
</div>
<div class="section" id="setting-up-virtual-environment">
<h3>Setting up Virtual Environment<a class="headerlink" href="#setting-up-virtual-environment" title="Permalink to this headline">¶</a></h3>
<p>We provide an <a class="reference external" href="https://github.com/HugoFara/leggedsnake/environment.yml">environment.yml</a> file for conda. Use <code class="docutils literal notranslate"><span class="pre">conda</span> <span class="pre">env</span> <span class="pre">update</span> <span class="pre">--file</span> <span class="pre">environment.yml</span> <span class="pre">--name</span> <span class="pre">pylinkage-env</span></code> to install the requirements in a separate environment.</p>
</div>
</div>
<div class="section" id="usage">
<h2>Usage<a class="headerlink" href="#usage" title="Permalink to this headline">¶</a></h2>
<p>As of today, the code is segmented in three parts:</p>
<ul class="simple">
<li><p><a class="reference external" href="https://github.com/HugoFara/pylinkage/blob/main/pylinkage/geometry.py">geometry.py</a> that module handles geometric primitives, such as circle intersections, distance claculation. It works in Euclidian space only. Aside from <code class="docutils literal notranslate"><span class="pre">dist</span></code> and <code class="docutils literal notranslate"><span class="pre">sqr_dist</span></code> functions, you might not use it directly.</p></li>
<li><p><a class="reference external" href="https://github.com/HugoFara/pylinkage/blob/main/pylinkage/linkage.py">linkage.py</a> this module describes joints and linkages</p>
<ul>
<li><p>Due to the geometric approach, joints (instances of <code class="docutils literal notranslate"><span class="pre">Joint</span></code> object) are defined without links.</p></li>
<li><p>The <code class="docutils literal notranslate"><span class="pre">Linkage</span></code> class that will make your code shorter.</p></li>
</ul>
</li>
<li><p><a class="reference external" href="https://github.com/HugoFara/pylinkage/blob/main/pylinkage/optimizer.py">optimizer.py</a> proposes three optimizations based on three techniques:</p>
<ul>
<li><p>The “exhaustive” optimization (<code class="docutils literal notranslate"><span class="pre">exhaustive_optimization</span></code> function) is a dumb optimization method, consisting or trying sequencially all positions. It is here for demonstration purposes only, and you should not use it if you are looking for an efficient technique.</p></li>
<li><p>The built-in Particle Swarm Optimizer (PSO). I started with it, so it offers a large set of useful options for linkage optimization. However, it is here for legacy purposes, and is much short than the PySwarms module.</p></li>
<li><p>PSO using <a class="reference external" href="https://github.com/ljvmiranda921/pyswarms">PySwarms</a>. We provide a wrapper function to PySwarm from ljvmiranda921, that will progressively be extended.</p></li>
</ul>
</li>
<li><p><a class="reference external" href="https://github.com/HugoFara/pylinkage/blob/main/pylinkage/visualizer.py">visualizer.py</a> can make graphic illustrations of your linkage using matplotlib.</p>
<ul>
<li><p>It is also used to visualise your n-dimensional swarm, which is not supported by PySwarms.</p></li>
</ul>
</li>
</ul>
</div>
<div class="section" id="requirements">
<h2>Requirements<a class="headerlink" href="#requirements" title="Permalink to this headline">¶</a></h2>
<p>Python 3, numpy for calculation, matplotlib for drawing, and standard libraries. You will also need PySwarms for the optimization since the built-in PSO is deprecated and will be removed soon.</p>
</div>
<div class="section" id="example">
<h2>Example<a class="headerlink" href="#example" title="Permalink to this headline">¶</a></h2>
<p>Let’s start with a crank-rocker <a class="reference external" href="https://en.wikipedia.org/wiki/Four-bar_linkage">four-bar linkage</a>, as classic of mechanics.</p>
<div class="section" id="joints-definition">
<h3>Joints definition<a class="headerlink" href="#joints-definition" title="Permalink to this headline">¶</a></h3>
<p>The first thing you need if to define points belonging to the frame:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">pylinkage.linkage</span> <span class="k">as</span> <span class="nn">pl</span>

<span class="n">frame_first</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">Static</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<span class="n">frame_second</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">Static</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</pre></div>
</div>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">O,</span> <span class="pre">O</span></code>: “x, y” position of the first point.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">3,</span> <span class="pre">0</span></code>: same for the second point.</p></li>
</ul>
<p>Then we have to define at least one crank because we do a kinematic simulation.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">crank</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">Crank</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">joint0</span><span class="o">=</span><span class="n">frame_first</span><span class="p">,</span> <span class="n">angle</span><span class="o">=</span><span class="mf">0.31</span><span class="p">,</span> <span class="n">distance</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
<p>Here you need some explanations:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">0,</span> <span class="pre">1</span></code>: x and y initial coordinates of the <strong>tail</strong> of the crank link.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">joint0</span></code>: the parent Joint to link with. The pin will be created on the position of the parent, which is the head of the crank link.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">angle</span></code>: the crank will rotate with this angle, in radians, at each iteration.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">distance</span></code>: distance to keep constant between crank link tail and head.</p></li>
</ul>
<p>Now we add a pin joint to close the kinematic loop.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">pin</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">Pivot</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">joint0</span><span class="o">=</span><span class="n">crank</span><span class="p">,</span> <span class="n">joint1</span><span class="o">=</span><span class="n">frame_second</span><span class="p">,</span> <span class="n">distance0</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">distance1</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
<p>Here comes some help:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">joint0</span></code>, <code class="docutils literal notranslate"><span class="pre">joint1</span></code>: first and second <code class="docutils literal notranslate"><span class="pre">Joint</span></code>s you want to link to, the order is not important.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">distance0</span></code>, <code class="docutils literal notranslate"><span class="pre">distance1</span></code>: distance to keep constant between this joint and his two parents.</p></li>
</ul>
<p>And here comes the pain:
Why do we specify initial coordinates <code class="docutils literal notranslate"><span class="pre">3,</span> <span class="pre">2</span></code>? Moreover, they seem incompatible with distance to parents/parents’ positions!</p>
<ul class="simple">
<li><p>This explanation is simple: mathematically a pin joint the intersection of two circles. The intersection is often two points. To choose the strating point, we calculate both intersection (when possible), then we keep the intersection closer to the previous position as the solution.</p></li>
</ul>
<p>Wait! A linkage with a single motor and only one pin joint? That doesn’t make sense!
:Behind the curtain, many joints are created on the fly. When you define a <code class="docutils literal notranslate"><span class="pre">Crank</span></code> joint, it creates a motor <strong>and</strong> a pin joint on the crank’s link head. For a <code class="docutils literal notranslate"><span class="pre">Pivot</span></code> joint, it creates <strong>3 pin joints</strong>: one on the position of each of its parents, and one its position, forming a reshapable triangle. This is why pylinkage is so short to write.</p>
</div>
<div class="section" id="linkage-definition-and-simulation">
<h3>Linkage definition and simulation<a class="headerlink" href="#linkage-definition-and-simulation" title="Permalink to this headline">¶</a></h3>
<p>Once your linkage is finished, you can either can the <code class="docutils literal notranslate"><span class="pre">reload</span></code> method of each <code class="docutils literal notranslate"><span class="pre">Joint</span></code> in a loop, or put everything in a <code class="docutils literal notranslate"><span class="pre">Linkage</span></code> that will handle this can of thinks for you.</p>
<p>Linkage definition is simple:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">my_linkage</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">Linkage</span><span class="p">(</span><span class="n">joints</span><span class="o">=</span><span class="p">(</span><span class="n">frame_first</span><span class="p">,</span> <span class="n">frame_second</span><span class="p">,</span> <span class="n">crank</span><span class="p">,</span> <span class="n">pin</span><span class="p">))</span>
</pre></div>
</div>
<p>That’s all!</p>
<p>Now we want to simulate it and to get the locus of <code class="docutils literal notranslate"><span class="pre">pin</span></code>. Just use the <code class="docutils literal notranslate"><span class="pre">step</span></code> method of <code class="docutils literal notranslate"><span class="pre">Linkage</span></code> to make a complete rotation.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">locus</span> <span class="o">=</span> <span class="n">my_linkage</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>
</pre></div>
</div>
<p>You can also specify the number of steps with the <code class="docutils literal notranslate"><span class="pre">iteration</span></code> argument, or subdivisions of each iteration with<code class="docutils literal notranslate"><span class="pre">dt</span></code>.</p>
<p>Let’s recape.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">pylinkage.linkage</span> <span class="k">as</span> <span class="nn">pl</span>

<span class="c1"># Static points in space, belonging to the frame</span>
<span class="n">frame_first</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">Static</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<span class="n">frame_second</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">Static</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<span class="c1"># Main motor</span>
<span class="n">crank</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">Crank</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">joint0</span><span class="o">=</span><span class="n">frame_first</span><span class="p">,</span> <span class="n">angle</span><span class="o">=</span><span class="mf">.31</span><span class="p">,</span> <span class="n">distance</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="c1"># Close the loop</span>
<span class="n">pin</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">Pivot</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">joint0</span><span class="o">=</span><span class="n">crank</span><span class="p">,</span> <span class="n">joint1</span><span class="o">=</span><span class="n">frame_second</span><span class="p">,</span>
               <span class="n">distance0</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">distance1</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="n">my_linkage</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">Linkage</span><span class="p">(</span><span class="n">joints</span><span class="o">=</span><span class="p">(</span><span class="n">frame_first</span><span class="p">,</span> <span class="n">frame_second</span><span class="p">,</span> <span class="n">crank</span><span class="p">,</span> <span class="n">pin</span><span class="p">))</span>

<span class="n">locus</span> <span class="o">=</span> <span class="n">my_linkage</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="section" id="visualization">
<h3>Visualization<a class="headerlink" href="#visualization" title="Permalink to this headline">¶</a></h3>
<p>Firsting first, you made a cool linkage, but only you know what it is. Let’s add friendly names to joints, so the communication is simplified.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">frame_first</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;A&quot;</span>
<span class="n">crank</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;B&quot;</span>
<span class="n">pin</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;C&quot;</span>
<span class="n">frame_second</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;D&quot;</span>
<span class="c1"># Linkage can also have names</span>
<span class="n">my_linkage</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;Four-bar linkage&quot;</span>
</pre></div>
</div>
<p>Then you can view your linkage!</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">pylinkage.visualizer</span> <span class="k">as</span> <span class="nn">visu</span>

<span class="n">visu</span><span class="o">.</span><span class="n">show_linkage</span><span class="p">(</span><span class="n">my_linkage</span><span class="p">)</span>
</pre></div>
</div>
<a class="reference external image-reference" href="https://github.com/HugoFara/pylinkage/raw/main/docs/examples/images/Kinematic%20My%20four-bar%20linkage.gif"><img alt="A four-bar linkage animated" src="https://github.com/HugoFara/pylinkage/raw/main/docs/examples/images/Kinematic%20My%20four-bar%20linkage.gif" /></a>
<p>Last recap, rearranging names:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">pylinkage.linkage</span> <span class="k">as</span> <span class="nn">pl</span>
<span class="kn">import</span> <span class="nn">pylinkage.visualizer</span> <span class="k">as</span> <span class="nn">visu</span>

<span class="c1"># Static points in space, belonging to the frame</span>
<span class="n">frame_first</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">Static</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;A&quot;</span><span class="p">)</span>
<span class="n">frame_second</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">Static</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;D&quot;</span><span class="p">)</span>
<span class="c1"># Main motor</span>
<span class="n">crank</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">Crank</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">joint0</span><span class="o">=</span><span class="n">frame_first</span><span class="p">,</span> <span class="n">angle</span><span class="o">=</span><span class="mf">.31</span><span class="p">,</span> <span class="n">distance</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;B&quot;</span><span class="p">)</span>
<span class="c1"># Close the loop</span>
<span class="n">pin</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">Pivot</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">joint0</span><span class="o">=</span><span class="n">crank</span><span class="p">,</span> <span class="n">joint1</span><span class="o">=</span><span class="n">frame_second</span><span class="p">,</span>
               <span class="n">distance0</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">distance1</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;C&quot;</span><span class="p">)</span>

<span class="c1"># Linkage definition</span>
<span class="n">my_linkage</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">Linkage</span><span class="p">(</span>
    <span class="n">joints</span><span class="o">=</span><span class="p">(</span><span class="n">crank</span><span class="p">,</span> <span class="n">pin</span><span class="p">),</span>
    <span class="n">order</span><span class="o">=</span><span class="p">(</span><span class="n">crank</span><span class="p">,</span> <span class="n">pin</span><span class="p">),</span>
    <span class="n">name</span><span class="o">=</span><span class="s2">&quot;My four-bar linkage&quot;</span>
<span class="p">)</span>

<span class="c1"># Visualization</span>
<span class="n">visu</span><span class="o">.</span><span class="n">show_linkage</span><span class="p">(</span><span class="n">my_linkage</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="optimization">
<h3>Optimization<a class="headerlink" href="#optimization" title="Permalink to this headline">¶</a></h3>
<p>Now, we want automatic optimization of our linkage, using a certain criterion. Let’s find a four-bar linkage that make a quarter of a circle. It is a common problem if you want to build a <a class="reference external" href="https://en.wikipedia.org/wiki/Windscreen_wiper">windscreen wiper</a> for instance.</p>
<p>Our objective function, often called the fitness function, is the following:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">pylinkage.geometry</span> <span class="kn">import</span> <span class="n">bounding_box</span>

<span class="c1"># We save initial position because we don&#39;t want a completely different movement</span>
<span class="n">init_pos</span> <span class="o">=</span> <span class="n">my_linkage</span><span class="o">.</span><span class="n">get_coords</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">fitness_func</span><span class="p">(</span><span class="n">linkage</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return how fit the locus is to describe a quarter of circle.</span>

<span class="sd">    It is a minisation problem and the theorical best score is 0.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">linkage</span><span class="o">.</span><span class="n">set_coords</span><span class="p">(</span><span class="n">init_pos</span><span class="p">)</span>
    <span class="n">linkage</span><span class="o">.</span><span class="n">set_num_constraints</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">points</span> <span class="o">=</span> <span class="mi">12</span>
        <span class="n">n</span> <span class="o">=</span> <span class="n">linkage</span><span class="o">.</span><span class="n">get_rotation_period</span><span class="p">()</span>
        <span class="c1"># Complete revolution with 12 points</span>
        <span class="nb">tuple</span><span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">linkage</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="n">iterations</span><span class="o">=</span><span class="n">points</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
                                             <span class="n">dt</span><span class="o">=</span><span class="n">n</span><span class="o">/</span><span class="n">points</span><span class="p">))</span>
        <span class="c1"># Again with n points, and at least 12 iterations</span>
        <span class="n">n</span> <span class="o">=</span> <span class="mi">96</span>
        <span class="n">factor</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">points</span> <span class="o">/</span> <span class="n">n</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="n">L</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">linkage</span><span class="o">.</span><span class="n">step</span><span class="p">(</span>
            <span class="n">iterations</span><span class="o">=</span><span class="n">n</span> <span class="o">*</span> <span class="n">factor</span><span class="p">,</span> <span class="n">dt</span><span class="o">=</span><span class="mi">1</span> <span class="o">/</span> <span class="n">factor</span><span class="p">))</span>
    <span class="k">except</span> <span class="n">UnbuildableError</span><span class="p">:</span>
        <span class="k">return</span> <span class="o">-</span><span class="nb">float</span><span class="p">(</span><span class="s1">&#39;inf&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Locus of the Joint &#39;pin&quot;, mast in linkage order</span>
        <span class="n">tip_locus</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">L</span><span class="p">)</span>
        <span class="c1"># We get the bounding box</span>
        <span class="n">curr_bb</span> <span class="o">=</span> <span class="n">bounding_box</span><span class="p">(</span><span class="n">tip_locus</span><span class="p">)</span>
        <span class="c1"># We set the reference bounding box with frame_second as down-left</span>
        <span class="c1"># corner and size 2</span>
        <span class="n">ref_bb</span> <span class="o">=</span> <span class="p">(</span><span class="n">frame_second</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="n">frame_second</span><span class="o">.</span><span class="n">x</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span>
                  <span class="n">frame_second</span><span class="o">.</span><span class="n">y</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="n">frame_second</span><span class="o">.</span><span class="n">x</span><span class="p">)</span>
        <span class="c1"># Our score is the square sum of the edges distances</span>
        <span class="k">return</span> <span class="o">-</span><span class="nb">sum</span><span class="p">((</span><span class="n">pos</span> <span class="o">-</span> <span class="n">ref_pos</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span>
                    <span class="k">for</span> <span class="n">pos</span><span class="p">,</span> <span class="n">ref_pos</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">curr_bb</span><span class="p">,</span> <span class="n">ref_bb</span><span class="p">))</span>
</pre></div>
</div>
<p>Please not that it is a <em>minization</em> problem, with 0 as lower bound.</p>
<p>We need to get the geometric constraints as the optimization parameters.
<code class="docutils literal notranslate"><span class="pre">constraints</span> <span class="pre">=</span> <span class="pre">tuple(my_linkage.get_num_constraints())`</span></code></p>
<p>With this constraints, score should be around -3.</p>
<p>Let’s start with a candide optimization, the <a class="reference external" href="https://en.wikipedia.org/wiki/Trial_and_error">trial-and-error</a> method. Here it is a serial test of switches.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Exhaustive optimization as an example ONLY</span>
<span class="n">score</span><span class="p">,</span> <span class="n">position</span><span class="p">,</span> <span class="n">coord</span> <span class="o">=</span> <span class="n">opti</span><span class="o">.</span><span class="n">exhaustive_optimization</span><span class="p">(</span>
    <span class="n">eval_func</span><span class="o">=</span><span class="n">fitness_func</span><span class="p">,</span>
    <span class="n">linkage</span><span class="o">=</span><span class="n">my_linkage</span><span class="p">,</span>
    <span class="n">delta_dim</span><span class="o">=</span><span class="mf">.1</span><span class="p">,</span>
    <span class="n">n_results</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
<span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</pre></div>
</div>
<p>Here the problem is simple enough, so that method typical return the maximal theorical value of 0.0.</p>
<p>However, with more complex linkages you need something more robust, and more efficient. Then we will use <a class="reference external" href="https://en.wikipedia.org/wiki/Particle_swarm_optimization">particle swarm optimization</a>. Here are the principles:</p>
<ul class="simple">
<li><p>The parameters are the geometric constrints (the dimensions) of the linkage.</p></li>
<li><p>A dimension set (a n-uplet) is called a <em>particule</em> or an <em>agents</em>. Think of it like a bee.</p></li>
<li><p>The particles move in a n-vectorial space. That is, if we have n geometric constraints, the particules move in a n-D space.</p></li>
<li><p>Together, the particules form the <em>swarm</em>.</p></li>
<li><p>Each time they move, their score is evaluated by our fitness function.</p></li>
<li><p>They know their best score, and know the current score of they neighbours.</p></li>
<li><p>Together they will try find the extremum in the space. Here it is a minimum.</p></li>
</ul>
<p>it is particularly relevant when the fitness function is not resource-greedy.</p>
<p>Due to incompatibilities, we need a wrapper.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># A simple wrapper</span>
<span class="k">def</span> <span class="nf">PSO_fitness_wrapper</span><span class="p">(</span><span class="n">constraints</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A simple wrapper to make the fitness function compatible.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">fitness_func</span><span class="p">(</span><span class="n">my_linkage</span><span class="p">,</span> <span class="n">constraints</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span>


<span class="c1"># We reinitialize the linkage (an optimal linkage is not interesting)</span>
<span class="n">my_linkage</span><span class="o">.</span><span class="n">set_num_constraints</span><span class="p">(</span><span class="n">constraints</span><span class="p">)</span>
<span class="c1"># As we do for initial positions</span>
<span class="n">my_linkage</span><span class="o">.</span><span class="n">set_coords</span><span class="p">(</span><span class="n">init_pos</span><span class="p">)</span>


<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="c1"># Optimization is more efficient with a start space</span>
<span class="n">bounds</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">constraints</span><span class="p">)),</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">constraints</span><span class="p">))</span> <span class="o">*</span> <span class="mi">5</span><span class="p">)</span>

<span class="n">score</span> <span class="o">=</span> <span class="n">opti</span><span class="o">.</span><span class="n">particle_swarm_optimization</span><span class="p">(</span>
    <span class="n">eval_func</span><span class="o">=</span><span class="n">PSO_fitness_wrapper</span><span class="p">,</span>
    <span class="n">linkage</span><span class="o">=</span><span class="n">my_linkage</span><span class="p">,</span>
    <span class="n">bounds</span><span class="o">=</span><span class="n">bounds</span>
<span class="p">)</span><span class="o">.</span><span class="n">swarm</span><span class="o">.</span><span class="n">best_cost</span>
</pre></div>
</div>
<p>Here again the result should be 0.0.</p>
<p>So we made something that say it works, let’s verify it:</p>
<a class="reference external image-reference" href="https://github.com/HugoFara/pylinkage/raw/main/docs/examples/images/Kinematic%20Windscreen%20wiper.gif"><img alt="An optimized four-bar linkage animated" src="https://github.com/HugoFara/pylinkage/raw/main/docs/examples/images/Kinematic%20Windscreen%20wiper.gif" /></a>
<p>With a bit of imagination you have a wonderful windscreen wiper!</p>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="changeloglink.html" class="btn btn-neutral float-right" title="Changelog" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="index.html" class="btn btn-neutral float-left" title="Welcome to pylinkage’s documentation!" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2021, Hugo Farajallah

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>